{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Mensajes - {{ request.user.username }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css?family=Grand+Hotel&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'myapp/css/inicio.css' %}">
        <style>
        body {
            background-color: black;
            color: white;
        }
        .sidebar-icon {
            width: 24px;
            height: 24px;
        }
        .story-ring {
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        }
    </style>
</head>
<body class="bg-black text-white font-sans">
    <div class="flex">
        <nav class="fixed h-screen w-[72px] overflow-x-hidden transition-all duration-300 border-r border-zinc-800 px-1 py-1 flex flex-col items-center bg-black z-50">
            <div class="py-4 mb-4 mt-2">
                <img src="{% static 'myapp/img/instagram.png' %}" alt="instagram" class="w-6 h-6 mb-4 mt-2">
            </div>
            
            <a href="{% url 'inicio' %}" class="flex justify-center w-full px-3 py-3 rounded-lg hover:bg-zinc-800 mt-3">
                <svg class="sidebar-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M9.005 16.545a2.997 2.997 0 012.997-2.997h0A2.997 2.997 0 0115 16.545V22h7V11.543L12 2 2 11.543V22h7.005z"/></svg>
                <span class="hidden">Inicio</span>
            </a>

                <button onclick="toggleSearch()" class="flex justify-center w-full gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mt-3 ">
                <img src="{% static 'myapp/img/busqueda.png' %}" alt="busqueda" class="w-7 h-7">
                </button>

                <div id="searchPanel" class="hidden absolute left-16 w-96 bg-neutral-800 rounded-xl shadow-xl mt-2 z-50">
                    <div class="p-4">
                        <div class="flex items-center gap-3 pb-3 border-b border-neutral-700">
                            <svg class="w-4 h-4 text-neutral-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/>
                            </svg>
                            <input type="text"
                                id="searchInput"
                                class="w-full bg-transparent text-white placeholder-neutral-400 focus:outline-none text-sm"
                                placeholder="Buscar">
                        </div>
                    </div>
                    <div id="searchResults" class="max-h-[400px] overflow-y-auto">

                    </div>
                    <div id="loadingIndicator" class="hidden p-4 text-center text-neutral-400">
                        <span>Buscando...</span>
                    </div>
                </div>

            <a href="#" class="flex justify-center w-full px-3 py-3 rounded-lg hover:bg-zinc-800 mt-3">
                <img src="{% static 'myapp/img/explorar.png' %}" alt="busqueda" class="w-7 h-7">
                <span class="hidden">Explorar</span>
            </a>

            <a href="{% url 'reels_feed' %}" class="flex justify-center w-full px-3 py-3 rounded-lg hover:bg-zinc-800 mt-3">
                <img src="{% static 'myapp/img/reels.png' %}" alt="busqueda" class="w-7 h-7">
                <span class="hidden">Reels</span>
            </a>

            <a href="{% url 'mensajes' %}" class="flex justify-center w-full gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-3">
                <img src="{% static 'myapp/img/mensajes.png' %}" alt="busqueda" class="w-7 h-7">
                <span class="hidden">Mensajes</span>
            </a>

            <a href="#" class="flex justify-center w-full items-center gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-3">
                <svg class="sidebar-icon" fill="currentColor" viewBox="0 0 24 24"><path d="M16.792 3.904A4.989 4.989 0 0121.5 9.122c0 3.072-2.652 4.959-5.197 7.222-2.512 2.243-3.865 3.469-4.303 3.752-.477-.309-2.143-1.823-4.303-3.752C5.141 14.072 2.5 12.167 2.5 9.122a4.989 4.989 0 014.708-5.218 4.21 4.21 0 013.675 1.941c.84 1.175.98 1.763 1.12 1.763s.278-.588 1.11-1.766a4.17 4.17 0 013.679-1.938m0-2a6.04 6.04 0 00-4.797 2.127 6.052 6.052 0 00-4.787-2.127A6.985 6.985 0 00.5 9.122c0 3.61 2.55 5.827 5.015 7.97.283.246.569.494.853.747l1.027.918a44.998 44.998 0 003.518 3.018 2 2 0 002.174 0 45.263 45.263 0 003.626-3.115l.922-.824c.293-.26.59-.519.885-.774 2.334-2.025 4.98-4.32 4.98-7.94a6.985 6.985 0 00-6.708-7.218z"/></svg>
                <span class="hidden">Notificaciones</span>
            </a>

            <div class="w-[63px] relative inline-block text-left cursor-pointer mr-4">
            <a onclick="toggleMenu()" class="flex justify-center w-full items-center gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-3">
                <img src="{% static 'myapp/img/mas.png' %}" alt="crear" class="w-6 h-6 justified-center">
            </a>

                <div id="dropdownMenu" class="hidden fixed left-1 top-[55%] w-56 rounded-md bg-neutral-800 text-white shadow-lg ring-1 ring-black ring-opacity-5 z-[9999]">
                    <button id="abrirModal" class="flex w-full items-center gap-2 px-4 py-3 rounded-md hover:bg-neutral-700">Publicación
                    <img src="{% static 'myapp/img/camara.png' %}" alt="publi" class="w-8 h-8 ml-[45%]">
                    </button>
                    <button onclick="abrirModalHistoria()" class="flex items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">
                        Historia
                        <img src="{% static 'myapp/img/historia.png' %}" alt="historia" class="w-6 h-6 ml-[60%]">
                    </button>
                    <button id="abrirReel" class="flex items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">
                        Subir Reel
                        <img src="{% static 'myapp/img/reels.png' %}" alt="anuncio" class="w-6 h-6 ml-[58%]">
                    </button>

                    <a href="#" class="flex items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">
                    IA
                    <img src="{% static 'myapp/img/ai.png' %}" alt="ai" class="w-6 h-6 ml-[80%]">
                    </a>
                </div>
            </div>

            <a href="{% url 'perfil' user.username %}" class="flex justify-center w-full items-center gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-3">
                    {% if user.imagen_perfil %}
                            <img src="{{ user.imagen_perfil.url }}" alt="Foto de perfil" class="w-7 h-7 object-cover rounded-full">
                        {% else %}
                            <img src="{% static 'img/perfil_default.jpg' %}" alt="Sin imagen" class="w-7 h-7 object-cover">
                    {% endif %}
                <span class="hidden">Perfil</span>
            </a>
            
            <a href="https://www.meta.ai/" class="flex justify-center w-full items-center gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-[407%]">
            <img src="{% static 'myapp/img/ai.png' %}" alt="ai" class="w-6 h-6">
            <span class="hidden">Meta AI</span>
            </a>

            <div class="w-[63px] relative inline-block text-left mr-4">
                <button onclick="Menumas()" class="flex justify-center w-full items-center gap-4 px-3 py-3 rounded-lg hover:bg-zinc-800 mx-2 mt-3">
                <img src="{% static 'myapp/img/menu.png' %}" alt="crear" class="w-6 h-6 justify-center">
                </button>

                <div id="MasMenu" class="hidden fixed left-1 top-[61%] w-56 rounded-md bg-neutral-800 text-white shadow-lg ring-1 ring-black ring-opacity-5 z-[9999]">
                    <a href="{% url 'editar_perfil' %}" class="flex w-full items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">Configuración
                    <img src="{% static 'myapp/img/confi.png' %}" alt="publi" class="w-7 h-7 ml-[35%]">
                    </a>
                    <a href="#" class="flex items-center gap-2 px-4 py-2 rounded-md hover:bg-neutral-700 mb-2">
                    Cambiar apariencia
                    <img src="{% static 'myapp/img/apariencia.png' %}" alt="historia" class="w-7 h-7 ml-[48%]">
                    </a>
                    <div class="border-t-4 border-b-2 border-neutral-700 mb-2 py-2">
                        <a href="{% url 'index' %}" class="flex items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">
                        Cambiar cuenta
                        <img src="{% static 'myapp/img/cambiar.png' %}" alt="anuncio" class="w-6 h-6 ml-[30%] rounded-full">
                        </a>
                    </div>
                    <a href="{% url 'cerrarse' %}" class="flex items-center gap-2 px-4 py-4 rounded-md hover:bg-neutral-700">
                    Salir
                    <img src="{% static 'myapp/img/salir.png' %}" alt="ai" class="w-7 h-7 ml-[67%]">
                    </a>
                </div>
            </div>
        </nav>

    <main class="flex-1 flex h-screen overflow-visible">
        
        <div class="w-[350px] border-r border-zinc-800 overflow-y-auto ml-[72px] z-[1]">
            <div class="p-4 border-b border-zinc-800 text-xl font-semibold">Mensajes</div>
            <ul>
                {% for seguido in seguidos %}
                <li class="hover:bg-zinc-800 cursor-pointer px-4 py-3 flex items-center gap-3">
                    <a href="{% url 'chat' seguido.username %}" class="flex items-center gap-3">
                        {% if seguido.imagen_perfil %}
                            <img src="{{ seguido.imagen_perfil.url }}" alt="Foto de perfil" class="w-10 h-10 object-cover rounded-full">
                        {% else %}
                            <img src="{% static 'myapp/img/perfil_default.jpg' %}" alt="Sin imagen" class="w-10 h-10 object-cover rounded-full">
                        {% endif %}
                        <div>
                            <div class="font-semibold text-white">{{ seguido.username }}</div>
                            <div class="text-zinc-400 text-sm">Enviar mensaje</div>
                        </div>
                    </a>
                </li>
                {% empty %}
                <li class="text-center text-zinc-400 px-4 py-4">No estás siguiendo a nadie aún.</li>
                {% endfor %}
            </ul>
        </div>

        <div class="flex-1 p-4">
            {% if receptor %}
            <h2 class="text-lg font-bold">Chat con {{ receptor.username }}</h2>

            <div id="chat-box" class="h-[calc(100vh-200px)] overflow-y-auto px-4 py-2 space-y-4">
                {% for mensaje in mensajes %}
                <div class="flex flex-col {% if mensaje.enviar == request.user %}items-end{% else %}items-start{% endif %}">
                    <div class="{% if mensaje.enviar == request.user %}bg-blue-500 text-white{% else %}bg-zinc-800 text-white{% endif %} rounded-2xl px-4 py-2 max-w-[80%]">
                        {{ mensaje.contenido }}
                    </div>
                </div>
                {% endfor %}
            </div>

            <form id="chat-form" class="flex gap-2 p-4 border-t border-zinc-800">
                {% csrf_token %}
                <input type="hidden" id="receptor" value="{{ receptor.username }}">
                <input type="text" id="mensaje"
                    class="flex-1 bg-zinc-800 text-white rounded-full px-4 py-2 focus:outline-none" 
                    placeholder="Escribe un mensaje...">
                <button type="submit" class="text-blue-500 font-semibold px-4">Enviar</button>
            </form>
            {% else %}
            <p>Selecciona un usuario para comenzar a chatear.</p>
            {% endif %}
        </div>

    </main>
</div>
    {% include 'paginas/crear_publi.html' %}
    {% include 'paginas/subir_historia.html' %}
    {% include 'paginas/visor_historias.html' %}

<script>
    const form = document.getElementById('chat-form');
    const mensajeInput = document.getElementById('mensaje');
    const receptor = document.getElementById('receptor')?.value;
    const chatBox = document.getElementById('chat-box');

    form?.addEventListener('submit', function (e) {
        e.preventDefault();

        fetch("{% url 'enviar_mensaje' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
                mensaje: mensajeInput.value,
                receptor: receptor
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.estado === 'ok') {
                const mensaje = `
                    <div class="flex flex-col items-end">
                        <div class="bg-blue-500 text-white rounded-2xl px-4 py-2 max-w-[80%]">
                            ${data.mensaje}
                        </div>
                    </div>`;
                chatBox.insertAdjacentHTML('beforeend', mensaje);
                mensajeInput.value = '';
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
    });

    // Cargar mensajes cada 3 segundos
    setInterval(() => {
        if (!receptor) return;
        fetch(`/obtener_mensajes/${receptor}/`)
            .then(response => response.json())
            .then(data => {
                chatBox.innerHTML = '';
                data.mensajes.forEach(msg => {
                    const isCurrentUser = msg.enviar === '{{ request.user.username }}';
                    const mensaje = `
                        <div class="flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'}">
                            <div class="${isCurrentUser ? 'bg-blue-500 text-white' : 'bg-zinc-800 text-white'} rounded-2xl px-4 py-2 max-w-[80%]">
                                ${msg.contenido}
                            </div>
                        </div>`;
                    chatBox.innerHTML += mensaje;
                });
                chatBox.scrollTop = chatBox.scrollHeight;
            });
    }, 2000);
</script>

        <!-- Modal (vacío al inicio) -->
    <div id="modalFormulario" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-[9999]">
        <div id="contenidoModal" class="bg-neutral-800 rounded-lg shadow-lg w-[400px] p-4 relative">
            <!-- Aquí se cargará el formulario -->
        </div>
    </div>

<script src="{% static 'myapp/js/inicio.js' %}"></script>
</body>
</html>
